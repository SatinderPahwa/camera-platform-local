# VBC01 Camera Platform - Local MQTT Edition

**A fully offline-capable camera management platform using EMQX local MQTT broker**

## Overview

This is a complete rewrite of the VBC01 camera management platform, designed to work entirely on your local network without any cloud dependencies. No AWS account required, no internet needed for camera operation.

## Key Features

- ✅ **Fully Offline Operation** - Works without internet connectivity
- ✅ **Local EMQX MQTT Broker** - Compatible with AWS IoT SDK v2.1.1
- ✅ **Zero Cloud Dependencies** - No AWS IoT Core required
- ✅ **Telegram Notifications** - Motion/person detection with thumbnails
- ✅ **WebRTC Livestreaming** - Real-time camera viewing
- ✅ **Encrypted Recordings** - Automatic recording storage and playback
- ✅ **Web Dashboard** - Camera control and event monitoring
- ✅ **One-Command Setup** - Automated platform deployment

## Quick Start

### Prerequisites

- Linux server (Ubuntu 22.04+ recommended)
- Python 3.8+
- Domain name pointing to your server
- Telegram bot token

### Installation

```bash
# Clone repository
git clone <repo-url> camera-platform-local
cd camera-platform-local

# Run setup wizard (auto-generates everything)
python3 setup_platform.py

# Start services
./scripts/managed_start.sh start
```

That's it! The setup wizard will:
- Generate all TLS certificates
- Configure EMQX broker
- Create camera deployment files
- Set up all services
- Generate personalized deployment guide

## Architecture

```
VBC01 Cameras → EMQX Broker (Local, Port 8883)
                    ↓
              MQTT Processor → Database
                    ↓
         Telegram Notifications
                    ↓
         Web Dashboard (Port 5000)
```

**No AWS, No Cloud, No Internet Required!**

## Documentation

- [Setup Guide](docs/SETUP_GUIDE.md) - Complete installation instructions
- [Architecture](docs/ARCHITECTURE.md) - System design and components
- [Camera Setup](docs/CAMERA_SETUP.md) - Adding cameras to platform
- [Deployment Guide](docs/DEPLOYMENT_GUIDE.md) - Server deployment
- [Troubleshooting](docs/TROUBLESHOOTING.md) - Common issues and solutions

## Components

- **EMQX Broker** - Local MQTT broker (port 8883)
- **Config Server** - Provides certificates to cameras (port 80)
- **MQTT Processor** - Processes camera events and notifications
- **Dashboard Server** - Web interface for camera management (port 5000)
- **Telegram Notifier** - Sends motion/person alerts with thumbnails
- **Livestreaming** - Kurento Media Server for WebRTC streaming

## Camera Support

- **Model:** VBC01 (Hive Camera)
- **Firmware:** FW117 and compatible versions
- **SDK:** AWS IoT SDK v2.1.1 (works with EMQX)
- **Connection:** MQTT over TLS (mutual TLS)

## Requirements

### Server
- 2GB RAM minimum (4GB recommended)
- 20GB disk space
- Static IP on local network
- Domain name (for external access)

### Software
- EMQX 5.8.8+
- Python 3.8+
- FFmpeg (for video processing)
- Kurento Media Server (for livestreaming)

## Configuration

All configuration is done via `.env` file (auto-generated by setup wizard):

```bash
# Network
EMQX_BROKER_ENDPOINT=camera.pahwa.net
CONFIG_SERVER_HOST=192.168.199.173

# Telegram
TELEGRAM_BOT_TOKEN=your_token
TELEGRAM_CHAT_ID=your_chat_id

# TURN Server (for remote access)
TURN_SERVER_URL=turns:camera.pahwa.net:5349
```

## Adding a Camera

```bash
# 1. Run camera setup (copies certificates)
python3 tools/add_camera.py

# 2. FTP files to camera at /root/certs/
cd camera_files/
# Upload: mqttCA.crt, mqtt.pem, mqtt.key

# 3. Reboot camera
# Camera auto-connects to local EMQX broker
```

## Development

```bash
# Install dependencies
pip install -r requirements.txt

# Run tests
pytest tests/

# Start individual services
python3 servers/enhanced_config_server.py
python3 servers/local_mqtt_processor.py
python3 servers/dashboard_server.py
```

## Migration from AWS IoT

If you have an existing AWS IoT-based deployment:

1. Deploy this platform on new server
2. Test with one camera
3. Migrate cameras one by one
4. Keep old server as backup

See [MIGRATION_GUIDE.md](docs/MIGRATION_GUIDE.md) for details.

## Differences from AWS IoT Version

| Feature | AWS IoT Version | Local Version |
|---------|----------------|---------------|
| **MQTT Broker** | AWS IoT Core (cloud) | EMQX (local) |
| **Internet** | Required | Optional |
| **Setup** | AWS account + credentials | Domain + IP only |
| **Certificates** | AWS IoT Things | Self-signed CA |
| **Cost** | AWS charges | Free (self-hosted) |
| **Notifications** | Slack + Telegram | Telegram only |

## Troubleshooting

### Camera won't connect
- Check EMQX is running: `emqx ctl status`
- Verify certificates on camera: checksums match
- Check domain resolves to your server

### No notifications
- Verify Telegram token: `curl https://api.telegram.org/bot<TOKEN>/getMe`
- Check processor logs: `tail -f logs/mqtt_processor.log`

### Dashboard not accessible
- Check service: `./scripts/managed_start.sh status`
- Verify port 5000 is open
- Check logs: `tail -f logs/dashboard_server.log`

## Contributing

This is a personal project, but contributions welcome!

## License

MIT License - See LICENSE file

## Credits

- Built for VBC01 Hive Cameras
- EMQX Broker - https://www.emqx.io/
- Kurento Media Server - https://www.kurento.org/

## Support

For issues, questions, or feature requests, please open an issue on GitHub.

---

**Built with ❤️ for privacy-focused, offline-capable home security**
